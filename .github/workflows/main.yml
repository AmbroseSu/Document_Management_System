name: Deploy .NET App to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH & Deploy
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_USERNAME: ${{ secrets.SERVER_USERNAME }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USERNAME@$SSH_HOST" << 'EOF'
            set -e
            echo "ðŸ“¥ Pulling latest code from Git..."
            cd /home/admin-kns/document_management_system_capstone_source/dms/Document_Management_System &&  git pull origin main || exit 1


            echo "ðŸ›‘ Stopping old containers (if any)..."
            docker-compose down || true

            echo "ðŸ”§ Building new image..."
            docker-compose build --no-cache

            echo "ðŸš€ Starting app..."
            docker-compose up -d --remove-orphans
          EOF
